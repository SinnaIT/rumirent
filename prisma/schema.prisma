generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  nombre    String
  rut       String     @unique
  telefono  String?
  role      Role       @default(BROKER)
  activo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  leads Lead[]
  clientes  Cliente[]  @relation("ClienteBroker")

  @@map("users")
}

model Edificio {
  id                 String                     @id @default(cuid())
  nombre             String
  direccion          String
  descripcion        String?
  comisionId         String
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  comision           Comision                   @relation(fields: [comisionId], references: [id])
  cambiosProgramados CambioComisionProgramado[]
  unidades           Unidad[]
  tiposUnidad        TipoUnidadEdificio[]
  leads          Lead[]                 @relation("LeadEdificio")

  @@map("edificios")
}

model TipoUnidadEdificio {
  id                 String                     @id @default(cuid())
  nombre             String
  codigo             String
  comisionId         String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  edificioId         String
  edificio           Edificio                   @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  comision           Comision?                  @relation("TipoUnidadComision", fields: [comisionId], references: [id])
  unidades           Unidad[]
  cambiosProgramados CambioComisionProgramado[]

  @@unique([edificioId, codigo])
  @@map("tipos_unidad_edificio")
}

model Unidad {
  id                   String             @id @default(cuid())
  numero               String
  estado               EstadoUnidad       @default(DISPONIBLE)
  descripcion          String?
  metros2              Float?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  edificioId           String
  tipoUnidadEdificioId String
  leads            Lead?
  edificio             Edificio           @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  tipoUnidadEdificio   TipoUnidadEdificio @relation(fields: [tipoUnidadEdificioId], references: [id])

  @@unique([edificioId, numero])
  @@map("unidades")
}

model Cliente {
  id            String     @id @default(cuid())
  nombre        String
  rut           String     @unique
  email         String?
  telefono      String?
  brokerId String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  broker   User       @relation("ClienteBroker", fields: [brokerId], references: [id])
  leads     Lead[]

  @@map("clientes")
}

model Lead {
  id                    String         @id @default(cuid())
  codigoUnidad          String?
  totalLead         Float
  montoUf               Float
  comision              Float
  estado                EstadoLead @default(ENTREGADO)
  fechaPagoReserva      DateTime?
  fechaPagoLead     DateTime?
  fechaCheckin          DateTime?
  postulacion           String?
  observaciones         String?
  conciliado            Boolean        @default(false)
  fechaConciliacion     DateTime?
  reglaComisionId       String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  brokerId         String
  clienteId             String
  unidadId              String?        @unique
  edificioId            String
  broker           User           @relation(fields: [brokerId], references: [id])
  cliente               Cliente        @relation(fields: [clienteId], references: [id])
  unidad                Unidad?        @relation(fields: [unidadId], references: [id])
  edificio              Edificio       @relation("LeadEdificio", fields: [edificioId], references: [id])
  reglaComision         ReglaComision? @relation(fields: [reglaComisionId], references: [id])

  @@map("leads")
}

model Comision {
  id                 String                     @id @default(cuid())
  nombre             String                     @unique
  codigo             String                     @unique
  porcentaje         Float
  activa             Boolean                    @default(true)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  edificios          Edificio[]
  tiposUnidad        TipoUnidadEdificio[]       @relation("TipoUnidadComision")
  cambiosProgramados CambioComisionProgramado[]
  reglasComision     ReglaComision[]

  @@map("comisiones")
}

model ReglaComision {
  id             String     @id @default(cuid())
  cantidadMinima Float
  cantidadMaxima Float?
  porcentaje     Float
  comisionId     String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  comision       Comision   @relation(fields: [comisionId], references: [id], onDelete: Cascade)
  leads      Lead[]

  @@map("reglas_comision")
}

model CambioComisionProgramado {
  id                   String              @id @default(cuid())
  fechaCambio          DateTime
  comisionId           String
  edificioId           String
  tipoUnidadEdificioId String?
  ejecutado            Boolean             @default(false)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  comision             Comision            @relation(fields: [comisionId], references: [id], onDelete: Cascade)
  edificio             Edificio            @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  tipoUnidadEdificio   TipoUnidadEdificio? @relation(fields: [tipoUnidadEdificioId], references: [id], onDelete: SetNull)

  @@map("cambios_comision_programados")
}

enum Role {
  ADMIN
  BROKER
}

enum EstadoUnidad {
  DISPONIBLE
  RESERVADA
  VENDIDA
}

enum EstadoLead {
  ENTREGADO
  RESERVA_PAGADA
  APROBADO
  RECHAZADO
}