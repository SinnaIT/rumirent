generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  password           String
  nombre             String
  rut                String        @unique
  telefono           String?
  role               Role          @default(BROKER)
  activo             Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  birthDate          DateTime?
  lastPasswordChange DateTime?
  mustChangePassword Boolean       @default(false)
  resetToken         String?
  resetTokenExpiry   DateTime?
  clientes           Cliente[]     @relation("ClienteBroker")
  leads              Lead[]
  metasMensuales     MetaMensual[]

  @@map("users")
}

model Empresa {
  id          String      @id @default(cuid())
  nombre      String
  rut         String      @unique
  razonSocial String
  direccion   String?
  telefono    String?
  email       String?
  activa      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tipoEntidad TipoEntidad @default(COMPANY)
  edificios   Edificio[]

  @@map("empresas")
}

model Edificio {
  id                 String                     @id @default(cuid())
  nombre             String
  direccion          String
  descripcion        String?
  comisionId         String
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  email              String?
  empresaId          String
  telefono           String?
  urlGoogleMaps      String?
  ciudad             String
  codigoPostal       String?
  comuna             String
  region             String
  cambiosProgramados CambioComisionProgramado[]
  caracteristicas    CaracteristicaEdificio[]
  comision           Comision                   @relation(fields: [comisionId], references: [id])
  empresa            Empresa                    @relation(fields: [empresaId], references: [id])
  imagenes           ImagenEdificio[]
  leads              Lead[]                     @relation("LeadEdificio")
  tiposUnidad        TipoUnidadEdificio[]
  unidades           Unidad[]

  @@map("edificios")
}

model ImagenEdificio {
  id          String        @id @default(cuid())
  edificioId  String
  url         String
  descripcion String?
  orden       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  imageType   TipoImagenUrl @default(URL)
  edificio    Edificio      @relation(fields: [edificioId], references: [id], onDelete: Cascade)

  @@map("imagenes_edificio")
}

model TipoCaracteristica {
  id              String                   @id @default(cuid())
  nombre          String                   @unique
  descripcion     String?
  activo          Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  caracteristicas CaracteristicaEdificio[]

  @@map("tipos_caracteristica")
}

model CaracteristicaEdificio {
  id                   String             @id @default(cuid())
  edificioId           String
  tipoCaracteristicaId String
  nombre               String
  valor                String
  mostrarEnResumen     Boolean            @default(true)
  icono                String?
  tipoIcono            TipoIcono          @default(LUCIDE)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  edificio             Edificio           @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  tipoCaracteristica   TipoCaracteristica @relation(fields: [tipoCaracteristicaId], references: [id])

  @@map("caracteristicas_edificio")
}

model TipoUnidadEdificio {
  id                String               @id @default(cuid())
  nombre            String
  codigo            String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  bathrooms         Int?
  bedrooms          Int?
  activo            Boolean              @default(true)
  descripcion       String?
  edificioId        String
  comisionId        String?
  plantillaOrigenId String?
  leads             Lead[]               @relation("LeadTipoUnidad")
  comision          Comision?            @relation("TipoUnidadComision", fields: [comisionId], references: [id])
  edificio          Edificio             @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  plantillaOrigen   PlantillaTipoUnidad? @relation(fields: [plantillaOrigenId], references: [id], onDelete: SetNull)
  unidades          Unidad[]

  @@unique([edificioId, codigo])
  @@map("tipos_unidad_edificio")
}

model Unidad {
  id                   String             @id @default(cuid())
  numero               String
  estado               EstadoUnidad       @default(DISPONIBLE)
  descripcion          String?
  metros2              Float?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  edificioId           String
  tipoUnidadEdificioId String
  leads                Lead?
  edificio             Edificio           @relation(fields: [edificioId], references: [id], onDelete: Cascade)
  tipoUnidadEdificio   TipoUnidadEdificio @relation(fields: [tipoUnidadEdificioId], references: [id])

  @@unique([edificioId, numero])
  @@map("unidades")
}

model Cliente {
  id              String    @id @default(cuid())
  nombre          String
  rut             String?
  email           String?
  telefono        String    @unique
  brokerId        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  direccion       String?
  fechaNacimiento DateTime?
  broker          User?     @relation("ClienteBroker", fields: [brokerId], references: [id])
  leads           Lead[]

  @@map("clientes")
}

model Lead {
  id                   String              @id @default(cuid())
  codigoUnidad         String?
  totalLead            Float
  montoUf              Float?
  comision             Float
  estado               EstadoLead          @default(INGRESADO)
  fechaPagoReserva     DateTime?
  fechaPagoLead        DateTime?
  fechaCheckin         DateTime?
  postulacion          String?
  observaciones        String?
  conciliado           Boolean             @default(false)
  fechaConciliacion    DateTime?
  reglaComisionId      String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  brokerId             String
  clienteId            String
  unidadId             String?             @unique
  edificioId           String
  comisionId           String?
  tipoUnidadEdificioId String?
  broker               User                @relation(fields: [brokerId], references: [id])
  cliente              Cliente             @relation(fields: [clienteId], references: [id])
  comisionBase         Comision?           @relation("LeadComisionBase", fields: [comisionId], references: [id])
  edificio             Edificio            @relation("LeadEdificio", fields: [edificioId], references: [id])
  reglaComision        ReglaComision?      @relation(fields: [reglaComisionId], references: [id])
  tipoUnidadEdificio   TipoUnidadEdificio? @relation("LeadTipoUnidad", fields: [tipoUnidadEdificioId], references: [id])
  unidad               Unidad?             @relation(fields: [unidadId], references: [id])

  @@map("leads")
}

model Comision {
  id                 String                     @id @default(cuid())
  nombre             String                     @unique
  codigo             String                     @unique
  porcentaje         Float
  activa             Boolean                    @default(true)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  cambiosProgramados CambioComisionProgramado[]
  edificios          Edificio[]
  leadsComisionBase  Lead[]                     @relation("LeadComisionBase")
  reglasComision     ReglaComision[]
  tiposUnidad        TipoUnidadEdificio[]       @relation("TipoUnidadComision")

  @@map("comisiones")
}

model ReglaComision {
  id             String   @id @default(cuid())
  cantidadMinima Float
  cantidadMaxima Float?
  porcentaje     Float
  comisionId     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  leads          Lead[]
  comision       Comision @relation(fields: [comisionId], references: [id], onDelete: Cascade)

  @@map("reglas_comision")
}

model CambioComisionProgramado {
  id          String   @id @default(cuid())
  fechaCambio DateTime
  comisionId  String
  edificioId  String
  ejecutado   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  comision    Comision @relation(fields: [comisionId], references: [id], onDelete: Cascade)
  edificio    Edificio @relation(fields: [edificioId], references: [id], onDelete: Cascade)

  @@map("cambios_comision_programados")
}

model MetaMensual {
  id        String   @id @default(cuid())
  brokerId  String?
  mes       Int
  anio      Int
  montoMeta Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  broker    User?    @relation(fields: [brokerId], references: [id], onDelete: Cascade)

  @@unique([brokerId, mes, anio])
  @@map("metas_mensuales")
}

model PlantillaTipoUnidad {
  id                 String               @id @default(cuid())
  nombre             String               @unique
  codigo             String               @unique
  bedrooms           Int?
  bathrooms          Int?
  descripcion        String?
  activo             Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  tiposUnidadCreados TipoUnidadEdificio[]

  @@map("plantillas_tipo_unidad")
}

enum TipoIcono {
  LUCIDE
  URL
  UPLOAD
}

enum TipoImagenUrl {
  URL
  UPLOAD
}

enum Role {
  ADMIN
  BROKER
}

enum TipoEntidad {
  COMPANY
  INVESTOR
}

enum EstadoUnidad {
  DISPONIBLE
  RESERVADA
  VENDIDA
}

enum EstadoLead {
  INGRESADO
  ENTREGADO
  EN_EVALUACION
  OBSERVADO
  APROBADO
  RESERVA_PAGADA
  CONTRATO_FIRMADO
  CONTRATO_PAGADO
  DEPARTAMENTO_ENTREGADO
  RECHAZADO
  CANCELADO
}
